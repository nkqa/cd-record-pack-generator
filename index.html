<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>我的世界音乐唱片替换工具（基岩版）</title>
    <script src="static/jszip/jszip.min.js"></script>
    <script src="static/jszip/FileSaver.min.js"></script>
    <script>
         var link = document.createElement('link');
         link.rel = 'stylesheet';
         link.href = 'https://static.mcneko.com/font-must.css';
         document.head.appendChild(link);
     </script>
    <link rel="stylesheet" href="static/css/style.css">
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "o11hourj5x");
    </script>
    <script>
        // 平滑滚动到指定元素
        function smoothScroll(elementId) {
            // 确保信息部分已展开
            const infoContent = document.querySelector('.info-content');
            if (infoContent && infoContent.style.display === 'none') {
                infoContent.style.display = 'block';
                const icon = document.querySelector('.toggle-icon');
                if (icon) {
                    icon.style.transform = 'rotate(180deg)';
                }
            }

            const element = document.getElementById(elementId);
            if (element) {
                // 自定义平滑滚动实现（强制使用，不依赖浏览器支持）
                const targetPosition = element.getBoundingClientRect().top + window.pageYOffset;
                const startPosition = window.pageYOffset;
                const distance = targetPosition - startPosition;
                const duration = 1000; // 滚动持续时间（毫秒）
                let startTime = null;

                function animation(currentTime) {
                    if (startTime === null) startTime = currentTime;
                    const timeElapsed = currentTime - startTime;
                    const run = ease(timeElapsed, startPosition, distance, duration);
                    window.scrollTo(0, run);
                    if (timeElapsed < duration) requestAnimationFrame(animation);
                }

                // 缓动函数，使滚动更自然
                function ease(t, b, c, d) {
                    t /= d / 2;
                    if (t < 1) return c / 2 * t * t + b;
                    t--;
                    return -c / 2 * (t * (t - 2) - 1) + b;
                }

                requestAnimationFrame(animation);
            }
        }
    </script>
    <script src="static/i18n/i18n.js"></script>
</head>
<body>
    <!-- 加载遮罩层 -->
    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;">
        <div style="width: 300px; height: 4px; background-color: #f0f0f0; border-radius: 2px; overflow: hidden;">
            <div id="loadingBar" style="width: 0%; height: 100%; background-color: #4CAF50; transition: width 0.3s ease;"></div>
        </div>
        <div style="margin-top: 20px; font-size: 16px; color: #333;">Loading...</div>
    </div>
    
    <div class="container">
        <h1>我的世界音乐唱片替换工具（基岩版）</h1>
        
        <!-- 介绍部分 -->
        <div class="info-section">
            <button class="info-toggle" onclick="toggleInfo()">
                <span class="toggle-icon">▼</span> 信息
            </button>
            <div class="info-content" style="display: none;">
                <p>开发者：<a href="https://meowco.cn" target="_blank">Meowco</a></p>
                <p>社区：<a href="https://www.mcneko.com" target="_blank">www.mcneko.com</a></p>
                <p>源代码: <a href="https://github.com/nkqa/cd-record-pack-generator/" target="_blank" rel="nofollow">GitHub</a></p>
                <h3>这个网站的用途是什么？</h3>
                <p>这个网站提供生成我的世界基岩版唱片替换功能</p>
                <h3>怎么使用该工具？</h3>
                <p>只需要将ogg格式的音频上传即可，需要注意下面的最高支持时间</p>
                <h3>为什么我无法上传或下载？</h3>
                <p>请使用 <font color="red">Chromium</font> 内核的浏览器进行操作，例如 <font color="red">Google Chrome、Microsoft Edge</font></p>
                <p>请确保您上传了正确的格式</p>
                <h3>我上传的音频格式不是ogg，有转换格式的工具吗？</h3>
                <p>有的，<a href="#convert-tools" onclick="smoothScroll('convert-tools'); return false;">点击这里</a>查看</p>
                <h3>感谢</h3>
                <p>感谢由<a href="https://www.bilibili.com/video/BV1DSBRYrE6N/" target="_blank" rel="nofollow">此视频</a>给我带来的启发以及文件提供</p>
            </div>
        </div>
        
        <div class="upload-section">
            <h2>上传音乐文件</h2>
            
            <div class="file-input">
                <label>11.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_11">
                    <div class="custom-btn" id="fileBtnText_11">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 1:10</div>
                <input type="text" id="desc_11" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>13.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_13">
                    <div class="custom-btn" id="fileBtnText_13">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 2:55</div>
                <input type="text" id="desc_13" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>5.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_5">
                    <div class="custom-btn" id="fileBtnText_5">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 3:00</div>
                <input type="text" id="desc_5" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>blocks.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_blocks" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_blocks">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 5:40</div>
                <input type="text" id="desc_blocks" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>cat.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_cat" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_cat">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 3:00</div>
                <input type="text" id="desc_cat" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>creator.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_creator" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_creator">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 2:50</div>
                <input type="text" id="desc_creator" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>creator_music_box.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_creator_music_box" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_creator_music_box">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 1:10</div>
                <input type="text" id="desc_creator_music_box" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>mall.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_mall" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_mall">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 3:15</div>
                <input type="text" id="desc_mall" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>mellohi.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_mellohi" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_mellohi">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 1:36</div>
                <input type="text" id="desc_mellohi" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>otherside.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_otherside" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_otherside">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 3:16</div>
                <input type="text" id="desc_otherside" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>pigstep_master.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_pigstep_master" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_pigstep_master">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 2:28</div>
                <input type="text" id="desc_pigstep_master" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>precipice.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_precipice" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_precipice">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 4:59</div>
                <input type="text" id="desc_precipice" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>relic.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_relic" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_relic">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 3:39</div>
                <input type="text" id="desc_relic" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>stal.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_stal" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_stal">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 2:31</div>
                <input type="text" id="desc_stal" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>strad.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_strad" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_strad">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 3:08</div>
                <input type="text" id="desc_strad" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>wait.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_wait" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_wait">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 3:58</div>
                <input type="text" id="desc_wait" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>ward.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_ward" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_ward">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 4:11</div>
                <input type="text" id="desc_ward" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>chirp.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_chirp" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_chirp">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 3:05</div>
                <input type="text" id="desc_chirp" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>far.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_far" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_far">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 2:50</div>
                <input type="text" id="desc_far" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>tears.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_tears" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_tears">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 2:55</div>
                <input type="text" id="desc_tears" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>lava_chicken.ogg</label>
                <div class="custom-file-upload">
                    <input type="file" id="oggFile_lava_chicken" accept=".ogg">
                    <div class="custom-btn" id="fileBtnText_lava_chicken">选择音频（不上传即为保持原版音乐）</div>
                </div>
                <div class="duration-warning">此名字的乐曲对应时长不能超过 2:15</div>
                <input type="text" id="desc_lava_chicken" placeholder="自定义描述（默认自动填入文件名）" style="margin-top: 5px;">
            </div>
            
            <div class="file-input">
                <label>音乐包图标</label>
                <div class="custom-file-upload">
                    <input type="file" id="iconFile">
                    <div class="custom-btn" id="iconBtnText">选择图标</div>
                </div>
                <div id="iconPreview" class="icon-preview"></div>
            </div>
            
            <div class="file-input">
                <label for="zipNameInput">音乐包名称</label>
                <input type="text" id="zipNameInput" placeholder="未输入则使用第一个上传文件的名字">
            </div>
        </div>
        
        <button class="btn" id="packBtn">生成mcpack文件</button>
        
        <div class="status" id="status"></div>
        
        <div class="notice-section">
            <h3>注意事项</h3>
            <p>每个乐曲选择按钮下方都标明了限制时长，如果上传的乐曲超过了限制，会直接被游戏强制停止播放</p>
            <p>部分浏览器会在文件名结尾增加.zip，如果遇到这种情况，需要自行去除</p>
        </div>
        
        <div class="tools-section" id="convert-tools">
            <h3>转换格式的工具</h3>
            <p>如果您要上传的是非 .ogg 格式的文件，则推荐使用以下在线转换工具：</p>
            <ul class="tool-links">
                <li><a href="https://www.freeconvert.com/ogg-converter" target="_blank" rel="nofollow">https://www.freeconvert.com/ogg-converter</a></li>
                <li><a href="https://convertio.co/zh/ogg-converter/" target="_blank" rel="nofollow">https://convertio.co/zh/ogg-converter/</a></li>
                <li><a href="https://www.audio2edit.com/zh/convert-to-ogg" target="_blank" rel="nofollow">https://www.audio2edit.com/zh/convert-to-ogg</a></li>
                <li><a href="https://www.aconvert.com/cn/audio/" target="_blank" rel="nofollow">https://www.aconvert.com/cn/audio/</a></li>
                <li><a href="https://www.xiaobaitool.net/audios/convert-to-ogg/" target="_blank" rel="nofollow">https://www.xiaobaitool.net/audios/convert-to-ogg/</a></li>
                <li><a href="https://audio-convert.com/cn/mp3-converter/mp3-to-ogg/" target="_blank" rel="nofollow">https://audio-convert.com/cn/mp3-converter/mp3-to-ogg/</a></li>
            </ul>
        </div>
        
        <!-- 背景图来源声明 -->
        <div class="background-notice">
            <p>背景图来源互联网，如果侵权请访问我的个人网站获取联系邮箱</p>
        </div>
    </div>
    
    <script>
        // 加载进度条逻辑
        let progress = 0;
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingBar = document.getElementById('loadingBar');
        let loadInterval = null;
        let timeoutId = null;
        
        // 模拟加载进度
        function startLoading() {
            progress = 0;
            loadInterval = setInterval(function() {
                progress += 5;
                if (progress <= 90) { // 只加载到90%，剩下的10%等所有资源加载完成后再加载
                    loadingBar.style.width = progress + '%';
                }
            }, 100);
            
            // 添加超时机制，最多加载10秒
            timeoutId = setTimeout(function() {
                completeLoading();
            }, 10000);
        }
        
        // 完成加载
        function completeLoading() {
            if (loadInterval) {
                clearInterval(loadInterval);
            }
            if (timeoutId) {
                clearTimeout(timeoutId);
            }
            // 加载到100%
            loadingBar.style.width = '100%';
            // 延迟一点时间再隐藏，让用户看到100%的状态
            setTimeout(function() {
                loadingOverlay.style.display = 'none';
            }, 500);
        }
        
        // 启动加载
        startLoading();
        
        // 监听所有资源加载完成
        window.onload = function() {
            completeLoading();
        };
        
        // 监听错误，即使有资源加载失败也继续
        window.onerror = function() {
            // 不做特殊处理，让加载继续
        };
        
        // 切换介绍部分的显示/隐藏
        function toggleInfo() {
            const content = document.querySelector('.info-content');
            const icon = document.querySelector('.toggle-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        // 平滑滚动到指定元素
        function smoothScroll(elementId) {
            // 确保信息部分已展开
            const infoContent = document.querySelector('.info-content');
            if (infoContent && infoContent.style.display === 'none') {
                infoContent.style.display = 'block';
                const icon = document.querySelector('.toggle-icon');
                if (icon) {
                    icon.style.transform = 'rotate(180deg)';
                }
            }

            const element = document.getElementById(elementId);
            if (element) {
                // 自定义平滑滚动实现（强制使用，不依赖浏览器支持）
                const targetPosition = element.getBoundingClientRect().top + window.pageYOffset;
                const startPosition = window.pageYOffset;
                const distance = targetPosition - startPosition;
                const duration = 1000; // 滚动持续时间（毫秒）
                let startTime = null;

                function animation(currentTime) {
                    if (startTime === null) startTime = currentTime;
                    const timeElapsed = currentTime - startTime;
                    const run = ease(timeElapsed, startPosition, distance, duration);
                    window.scrollTo(0, run);
                    if (timeElapsed < duration) requestAnimationFrame(animation);
                }

                // 缓动函数，使滚动更自然
                function ease(t, b, c, d) {
                    t /= d / 2;
                    if (t < 1) return c / 2 * t * t + b;
                    t--;
                    return -c / 2 * (t * (t - 2) - 1) + b;
                }

                requestAnimationFrame(animation);
            }
        }
        
        // 根据窗口宽高比设置背景图片
        function setBackgroundByAspectRatio() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const aspectRatio = width / height;
            
            // 如果宽大于高，使用桌面版背景，否则使用移动版背景
            if (aspectRatio > 1) {
                document.body.style.backgroundImage = "url('static/img/bg/pc.webp')";
            } else {
                document.body.style.backgroundImage = "url('static/img/bg/mobile.webp')";
            }
        }
        
        // 页面加载时设置背景
        window.onload = function() {
            setBackgroundByAspectRatio();
        };
        
        // 窗口大小改变时重新设置背景
        window.onresize = function() {
            setBackgroundByAspectRatio();
        };
        
        // 生成UUID函数
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // 为每个文件上传按钮添加事件监听器
        const fileInputs = [
            { id: 'oggFile_11', btnId: 'fileBtnText_11', targetName: '11.ogg' },
            { id: 'oggFile_13', btnId: 'fileBtnText_13', targetName: '13.ogg' },
            { id: 'oggFile_5', btnId: 'fileBtnText_5', targetName: '5.ogg' },
            { id: 'oggFile_blocks', btnId: 'fileBtnText_blocks', targetName: 'blocks.ogg' },
            { id: 'oggFile_cat', btnId: 'fileBtnText_cat', targetName: 'cat.ogg' },
            { id: 'oggFile_creator', btnId: 'fileBtnText_creator', targetName: 'creator.ogg' },
            { id: 'oggFile_creator_music_box', btnId: 'fileBtnText_creator_music_box', targetName: 'creator_music_box.ogg' },
            { id: 'oggFile_mall', btnId: 'fileBtnText_mall', targetName: 'mall.ogg' },
            { id: 'oggFile_mellohi', btnId: 'fileBtnText_mellohi', targetName: 'mellohi.ogg' },
            { id: 'oggFile_otherside', btnId: 'fileBtnText_otherside', targetName: 'otherside.ogg' },
            { id: 'oggFile_pigstep_master', btnId: 'fileBtnText_pigstep_master', targetName: 'pigstep_master.ogg' },
            { id: 'oggFile_precipice', btnId: 'fileBtnText_precipice', targetName: 'precipice.ogg' },
            { id: 'oggFile_relic', btnId: 'fileBtnText_relic', targetName: 'relic.ogg' },
            { id: 'oggFile_stal', btnId: 'fileBtnText_stal', targetName: 'stal.ogg' },
            { id: 'oggFile_strad', btnId: 'fileBtnText_strad', targetName: 'strad.ogg' },
            { id: 'oggFile_wait', btnId: 'fileBtnText_wait', targetName: 'wait.ogg' },
            { id: 'oggFile_ward', btnId: 'fileBtnText_ward', targetName: 'ward.ogg' },
            { id: 'oggFile_chirp', btnId: 'fileBtnText_chirp', targetName: 'chirp.ogg' },
            { id: 'oggFile_far', btnId: 'fileBtnText_far', targetName: 'far.ogg' },
            { id: 'oggFile_tears', btnId: 'fileBtnText_tears', targetName: 'tears.ogg' },
            { id: 'oggFile_lava_chicken', btnId: 'fileBtnText_lava_chicken', targetName: 'lava_chicken.ogg' }
        ];
        
        // 保存每个音频文件的上一次成功上传信息
        const lastValidAudioFiles = {};
        
        // 当前要删除的元素信息
        let currentDeleteTarget = null;
        let currentDeleteType = null;
        
        // 打开删除弹窗
        function openDeleteModal(target, type, name) {
            currentDeleteTarget = target;
            currentDeleteType = type;
            const modal = document.getElementById('deleteModal');
            const message = document.getElementById('deleteMessage');
            
            if (type === 'audio') {
                message.textContent = `确认删除 ${name} 吗？`;
            } else if (type === 'icon') {
                message.textContent = '确认删除图标吗？';
            }
            
            modal.style.display = 'block';
        }
        
        // 关闭删除弹窗
        function closeModal() {
            const modal = document.getElementById('deleteModal');
            modal.style.display = 'none';
            currentDeleteTarget = null;
            currentDeleteType = null;
        }
        
        // 确认删除
        function confirmDelete() {
            if (currentDeleteType === 'audio') {
                // 重置音频文件输入
                const fileInput = currentDeleteTarget;
                const btnText = document.getElementById(currentDeleteTarget.id.replace('oggFile_', 'fileBtnText_'));
                const errorDiv = fileInput.parentElement.parentElement.querySelector('.format-error');
                const deleteBtn = fileInput.parentElement.parentElement.querySelector('.delete-btn');
                const recordKey = currentDeleteTarget.id.replace('oggFile_', '');
                const descInput = document.getElementById(`desc_${recordKey}`);
                
                // 重置文件输入
                fileInput.value = '';
                btnText.textContent = '选择音频（不上传即为保持原版音乐）';
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
                if (deleteBtn) {
                    deleteBtn.style.display = 'none'; // 删除后隐藏删除按钮
                }
                if (descInput) {
                    descInput.value = ''; // 删除后清空描述输入框
                }
                
                // 从lastValidAudioFiles中删除对应的条目
                delete lastValidAudioFiles[fileInput.id];
            } else if (currentDeleteType === 'icon') {
                // 重置图标文件输入
                const iconFileInput = document.getElementById('iconFile');
                const iconBtnText = document.getElementById('iconBtnText');
                const iconPreview = document.getElementById('iconPreview');
                const iconErrorDiv = iconFileInput.parentElement.parentElement.querySelector('.format-error');
                const iconDeleteBtn = iconFileInput.parentElement.parentElement.querySelector('.delete-btn');
                
                // 重置文件输入和状态
                iconFileInput.value = '';
                iconBtnText.textContent = '选择图标';
                iconPreview.innerHTML = '';
                if (iconErrorDiv) {
                    iconErrorDiv.style.display = 'none';
                }
                if (iconDeleteBtn) {
                    iconDeleteBtn.style.display = 'none'; // 删除后隐藏删除按钮
                }
                lastValidIconFile = null;
                lastValidIconPreview = '';
                lastValidIconName = '';
            }
            
            closeModal();
        }
        
        // 点击弹窗外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('deleteModal');
            if (event.target == modal) {
                closeModal();
            }
        }
        
        fileInputs.forEach(input => {
            const fileInput = document.getElementById(input.id);
            const btnText = document.getElementById(input.btnId);
            const customUpload = fileInput.parentElement;
            
            // 创建按钮容器
            const btnContainer = document.createElement('div');
            btnContainer.className = 'btn-container';
            
            // 创建新的自定义上传区域，只包含文件输入和选择按钮
            const newCustomUpload = document.createElement('div');
            newCustomUpload.className = 'custom-file-upload';
            
            // 移动现有元素到新的上传区域中
            while (customUpload.firstChild) {
                newCustomUpload.appendChild(customUpload.firstChild);
            }
            
            // 创建删除按钮
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = '删除';
            deleteBtn.onclick = function() {
                openDeleteModal(fileInput, 'audio', input.targetName);
            };
            deleteBtn.style.display = 'none'; // 默认隐藏删除按钮
            
            // 将新的上传区域和删除按钮添加到按钮容器
            btnContainer.appendChild(newCustomUpload);
            btnContainer.appendChild(deleteBtn);
            
            // 将按钮容器添加到原始上传区域
            customUpload.appendChild(btnContainer);
            
            // 添加错误提示区域
            const errorDiv = document.createElement('div');
            errorDiv.className = 'format-error';
            errorDiv.style.display = 'none';
            customUpload.appendChild(errorDiv); // 将错误提示添加到上传区域的最下方
            
            fileInput.addEventListener('change', function() {
                const status = document.getElementById('status');
                const oggFile = this.files[0];
                const deleteBtn = this.parentElement.parentElement.querySelector('.delete-btn');
                const recordKey = input.id.replace('oggFile_', '');
                const descInput = document.getElementById(`desc_${recordKey}`);
                
                // 隐藏全局错误提示
                status.textContent = '';
                status.className = 'status';
                
                // 隐藏当前文件的错误提示
                errorDiv.style.display = 'none';
                
                if (oggFile) {
                    if (!oggFile.name.endsWith('.ogg')) {
                        // 显示红色框警告提示
                        errorDiv.textContent = '错误：格式必须为 .ogg';
                        errorDiv.style.display = 'block';
                        
                        // 保持上一次成功上传的音频
                        if (lastValidAudioFiles[input.id]) {
                            const lastValidFile = lastValidAudioFiles[input.id];
                            btnText.textContent = `已选择文件：${lastValidFile.name}`;
                            deleteBtn.style.display = 'block'; // 有有效音频时显示删除按钮
                            
                            // 保持上一次的描述
                            if (descInput) {
                                descInput.value = lastValidFile.description;
                            }
                        } else {
                            btnText.textContent = '选择音频（不上传即为保持原版音乐）';
                            deleteBtn.style.display = 'none'; // 无有效音频时隐藏删除按钮
                            
                            // 清空描述输入框
                            if (descInput) {
                                descInput.value = '';
                            }
                        }
                    } else {
                        // 保存当前有效的音频信息
                        const fileNameWithoutExt = oggFile.name.replace('.ogg', '');
                        lastValidAudioFiles[input.id] = {
                            file: oggFile,
                            name: oggFile.name,
                            description: fileNameWithoutExt
                        };
                        
                        btnText.textContent = `已选择文件：${oggFile.name}`;
                        deleteBtn.style.display = 'block'; // 选择文件后显示删除按钮
                        
                        // 自动填入文件名（不含扩展名）到描述输入框
                        if (descInput) {
                            descInput.value = fileNameWithoutExt;
                        }
                    }
                } else {
                    // 如果用户取消选择文件，保持上一次成功上传的音频
                    if (lastValidAudioFiles[input.id]) {
                        const lastValidFile = lastValidAudioFiles[input.id];
                        btnText.textContent = `已选择文件：${lastValidFile.name}`;
                        deleteBtn.style.display = 'block'; // 有有效音频时显示删除按钮
                        
                        // 保持上一次的描述
                        if (descInput) {
                            descInput.value = lastValidFile.description;
                        }
                    } else {
                        btnText.textContent = '选择音频（不上传即为保持原版音乐）';
                        deleteBtn.style.display = 'none'; // 未选择文件时隐藏删除按钮
                        
                        // 清空描述输入框
                        if (descInput) {
                            descInput.value = '';
                        }
                    }
                }
            });
        });
        
        // 图标上传事件监听器
        const iconFileInput = document.getElementById('iconFile');
        const iconBtnText = document.getElementById('iconBtnText');
        const iconPreview = document.getElementById('iconPreview');
        const iconCustomUpload = iconFileInput.parentElement;
        
        // 创建按钮容器
        const iconBtnContainer = document.createElement('div');
        iconBtnContainer.className = 'btn-container';
        
        // 创建新的自定义上传区域，只包含文件输入和选择按钮
        const newIconCustomUpload = document.createElement('div');
        newIconCustomUpload.className = 'custom-file-upload';
        
        // 移动现有元素到新的上传区域中
        while (iconCustomUpload.firstChild) {
            newIconCustomUpload.appendChild(iconCustomUpload.firstChild);
        }
        
        // 创建删除按钮
        const iconDeleteBtn = document.createElement('button');
        iconDeleteBtn.className = 'delete-btn';
        iconDeleteBtn.textContent = '删除';
        iconDeleteBtn.onclick = function() {
            openDeleteModal(iconFileInput, 'icon');
        };
        iconDeleteBtn.style.display = 'none'; // 默认隐藏删除按钮
        
        // 将新的上传区域和删除按钮添加到按钮容器
        iconBtnContainer.appendChild(newIconCustomUpload);
        iconBtnContainer.appendChild(iconDeleteBtn);
        
        // 将按钮容器添加到原始上传区域
        iconCustomUpload.appendChild(iconBtnContainer);
        
        // 添加图标错误提示区域
        const iconErrorDiv = document.createElement('div');
        iconErrorDiv.className = 'format-error';
        iconErrorDiv.style.display = 'none';
        iconCustomUpload.appendChild(iconErrorDiv); // 将错误提示添加到上传区域的最下方
        
        // 保存上一次成功上传的图标信息
        let lastValidIconFile = null;
        let lastValidIconPreview = '';
        let lastValidIconName = '';
        
        iconFileInput.addEventListener('change', function() {
            const status = document.getElementById('status');
            const iconFile = this.files[0];
            const iconDeleteBtn = this.parentElement.parentElement.querySelector('.delete-btn');
            
            // 隐藏全局错误提示
            status.textContent = '';
            status.className = 'status';
            
            // 隐藏图标错误提示
            iconErrorDiv.style.display = 'none';
            
            if (iconFile) {
                if (!iconFile.name.endsWith('.png')) {
                    // 显示红色框警告提示
                    iconErrorDiv.textContent = '错误：格式必须为 .png';
                    iconErrorDiv.style.display = 'block';
                    
                    // 保持上一次成功上传的图标
                    if (lastValidIconFile) {
                        iconBtnText.textContent = `已选择图标：${lastValidIconName}`;
                        iconPreview.innerHTML = lastValidIconPreview;
                        iconDeleteBtn.style.display = 'block'; // 有有效图标时显示删除按钮
                    } else {
                        iconBtnText.textContent = '选择图标';
                        iconPreview.innerHTML = '';
                        iconDeleteBtn.style.display = 'none'; // 无有效图标时隐藏删除按钮
                    }
                } else {
                    // 保存当前有效的图标信息
                    lastValidIconFile = iconFile;
                    lastValidIconName = iconFile.name;
                    
                    iconBtnText.textContent = `已选择图标：${iconFile.name}`;
                    iconDeleteBtn.style.display = 'block'; // 选择图标后显示删除按钮
                    
                    // 预览图标
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewHTML = `<img src="${e.target.result}" alt="图标预览">`;
                        iconPreview.innerHTML = previewHTML;
                        lastValidIconPreview = previewHTML;
                    };
                    reader.readAsDataURL(iconFile);
                }
            } else {
                // 如果用户取消选择文件，保持上一次成功上传的图标
                if (lastValidIconFile) {
                    iconBtnText.textContent = `已选择图标：${lastValidIconName}`;
                    iconPreview.innerHTML = lastValidIconPreview;
                    iconDeleteBtn.style.display = 'block'; // 有有效图标时显示删除按钮
                } else {
                    iconBtnText.textContent = '选择图标';
                    iconPreview.innerHTML = '';
                    iconDeleteBtn.style.display = 'none'; // 无有效图标时隐藏删除按钮
                }
            }
        });
        
        // 打包压缩功能
        document.getElementById('packBtn').addEventListener('click', async function() {
            const status = document.getElementById('status');
            status.textContent = '';
            status.className = 'status';
            
            try {
                // 收集所有上传的文件
                const uploadedFiles = [];
                fileInputs.forEach(input => {
                    let file = null;
                    
                    // 优先使用lastValidAudioFiles中保存的有效文件
                    if (lastValidAudioFiles[input.id]) {
                        file = lastValidAudioFiles[input.id].file;
                    } else {
                        const fileInput = document.getElementById(input.id);
                        file = fileInput.files[0];
                    }
                    
                    if (file) {
                        if (!file.name.endsWith('.ogg')) {
                            throw new Error(`上传失败，${input.targetName} 的文件格式必须是.ogg`);
                        }
                        uploadedFiles.push({ file, targetName: input.targetName });
                    }
                });
                
                // 验证至少上传了一个文件
                if (uploadedFiles.length === 0) {
                    throw new Error('请至少上传一个 .ogg 格式文件');
                }
                
                // 获取用户输入的音乐包名称，如果未输入则使用第一个上传文件的名字
                let defaultPackName = '音乐唱片';
                let defaultZipName = '音乐唱片';
                if (uploadedFiles.length > 0) {
                    defaultPackName = uploadedFiles[0].file.name;
                    defaultZipName = uploadedFiles[0].file.name.replace('.ogg', '');
                }
                const packName = document.getElementById('zipNameInput').value || defaultPackName;
                const zipName = document.getElementById('zipNameInput').value || defaultZipName;
                
                // 创建JSZip实例
                const zip = new JSZip();
                
                // 处理图标文件
                const iconFile = document.getElementById('iconFile').files[0];
                if (lastValidIconFile) {
                    // 使用上一次成功上传的图标
                    zip.file('pack_icon.png', lastValidIconFile);
                } else if (iconFile && iconFile.name.endsWith('.png')) {
                    // 如果没有上一次成功上传的图标，但当前选择的是有效图标
                    zip.file('pack_icon.png', iconFile);
                } else {
                    // 使用默认图标
                    try {
                        // 由于浏览器安全限制，我们无法直接读取本地文件
                        // 但我们可以使用fetch从服务器获取默认图标
                        const response = await fetch('static/img/pack/pack_icon.png');
                        const blob = await response.blob();
                        zip.file('pack_icon.png', blob);
                    } catch (error) {
                        console.error('获取默认图标失败:', error);
                    }
                }
                
                // 创建manifest.json文件
                const manifest = {
                    "format_version": 1,
                    "header": {
                        "description": "音乐唱片包",
                        "name": packName,
                        "uuid": generateUUID(),
                        "version": [1, 0, 0]
                    },
                    "modules": [
                        {
                            "description": "音乐唱片资源",
                            "type": "resources",
                            "uuid": generateUUID(),
                            "version": [1, 0, 0]
                        }
                    ]
                };
                zip.file('manifest.json', JSON.stringify(manifest, null, 2));
                
                // 创建texts文件夹和zh_CN.lang文件
                const texts = zip.folder('texts');
                
                // 生成描述文本
                let zhCNLangContent = '';
                
                // 为每个音乐唱片生成描述
                uploadedFiles.forEach(item => {
                    const targetName = item.targetName;
                    const recordKey = targetName.replace('.ogg', '');
                    const descInput = document.getElementById(`desc_${recordKey}`);
                    
                    // 获取用户输入的描述，如果没有则使用文件名（不含扩展名）
                    let description = descInput ? descInput.value.trim() : '';
                    if (!description) {
                        description = item.file.name.replace('.ogg', '');
                    }
                    
                    // 添加到lang文件内容，只添加带有.desc的条目
                    zhCNLangContent += `item.record_${recordKey}.desc=${description}\n`;
                });
                
                texts.file('zh_CN.lang', zhCNLangContent);
                
                // 创建sounds/music/game/records文件夹并添加用户上传的.ogg文件
                const sounds = zip.folder('sounds');
                const music = sounds.folder('music');
                const game = music.folder('game');
                const records = game.folder('records');
                
                // 添加所有上传的文件
                uploadedFiles.forEach(item => {
                    records.file(item.targetName, item.file);
                });
                
                // 创建textures文件夹结构
                const textures = zip.folder('textures');
                const items = textures.folder('items');
                const ui = textures.folder('ui');
                
                // 创建文件列表
                const filePaths = [];
                
                // 添加基本文件路径
                filePaths.push('manifest.json');
                filePaths.push('texts/zh_CN.lang');
                filePaths.push('pack_icon.png');
                
                // 添加上传的文件路径
                uploadedFiles.forEach(item => {
                    filePaths.push(`sounds/music/game/records/${item.targetName}`);
                });
                
                // 添加textures目录结构到文件列表
                filePaths.push('textures/items/apple_golden.png');
                filePaths.push('textures/items/record_11.png');
                filePaths.push('textures/items/record_13.png');
                filePaths.push('textures/items/record_5.png');
                filePaths.push('textures/items/record_blocks.png');
                filePaths.push('textures/items/record_cat.png');
                filePaths.push('textures/ui/2hangar.png');
                filePaths.push('textures/ui/5stars_empty.png');
                filePaths.push('textures/ui/5stars_full.png');
                
                // 创建filelist.txt
                const fileListContent = filePaths.sort().join('\n');
                zip.file('filelist.txt', fileListContent);
                
                // 生成压缩包
                const content = await zip.generateAsync({ type: 'blob' });
                
                // 下载压缩包
                saveAs(content, `${zipName}.mcpack`);
                
                // 显示成功信息
                status.textContent = 'mcpack文件已成功生成并开始下载';
                status.className = 'status success';
                
            } catch (error) {
                // 显示错误信息
                status.textContent = '错误: ' + error.message;
                status.className = 'status error';
            }
        });
    </script>
    
    <!-- 删除确认弹窗 -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <p id="deleteMessage">确认删除？</p>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeModal()">不删除</button>
                <button class="confirm-btn" onclick="confirmDelete()">确认删除</button>
            </div>
        </div>
    </div>
</body>
</html>